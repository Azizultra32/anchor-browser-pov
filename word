#!/usr/bin/env bash
set -euo pipefail

ROOT="$(cd "$(dirname "$0")" && pwd)"
LOGS="$ROOT/logs"
PROFILE="/tmp/anchor-mcp"
PORT=9222
EXT_DIR="$ROOT/extension/dist"
CHROME="/Applications/Google Chrome.app/Contents/MacOS/Google Chrome"

mkdir -p "$LOGS"

alive() { lsof -i :"$1" >/dev/null 2>&1; }
curl_ok() { curl -fsS "$1" >/dev/null 2>&1; }

start_chrome() {
  pkill -f "remote-debugging-port=$PORT" || true
  sleep 0.5

  nohup "$CHROME" \
    --remote-debugging-port="$PORT" \
    --user-data-dir="$PROFILE" \
    --disable-extensions-except="$EXT_DIR" \
    --load-extension="$EXT_DIR" \
    --disable-extensions-file-access-check \
    --allow-file-access-from-files \
    --disable-web-security \
    > "$LOGS/chrome.log" 2>&1 &

  for i in {1..40}; do
    curl_ok "http://localhost:$PORT/json/version" && break
    sleep 0.25
  done
  curl_ok "http://localhost:$PORT/json/version" || { echo "Chrome DevTools not reachable on :$PORT"; exit 1; }
}

start_agent() {
  (
    cd "$ROOT/agent"
    if [ -f package.json ] && grep -q '"dev"' package.json; then
      nohup npm run dev > "$LOGS/agent.log" 2>&1 &
    elif [ -f server.js ]; then
      nohup node server.js > "$LOGS/agent.log" 2>&1 &
    else
      echo "Agent start command not found (need npm run dev or server.js)"; exit 1
    fi
  )
  for i in {1..40}; do curl_ok "http://localhost:8787/" && break; sleep 0.25; done
  curl_ok "http://localhost:8787/" || { echo "Agent not responding on :8787"; exit 1; }
}

start_demo() {
  ( cd "$ROOT/demo" && nohup python3 -m http.server 8788 > "$LOGS/demo.log" 2>&1 & )
  for i in {1..40}; do alive 8788 && break; sleep 0.25; done
  alive 8788 || { echo "Demo server not listening on :8788"; exit 1; }
}

status() {
  echo "== Status @ $(date) =="
  printf "%-30s %s\n" "Chrome (DevTools :$PORT)" "$(alive $PORT && echo RUNNING || echo DOWN)"
  printf "%-30s %s\n" "Agent (:8787)"         "$(alive 8787 && echo RUNNING || echo DOWN)"
  printf "%-30s %s\n" "Demo (:8788)"          "$(alive 8788 && echo RUNNING || echo DOWN)"
  echo
  echo "-- Last 5 lines: chrome.log --"; tail -n 5 "$LOGS/chrome.log" 2>/dev/null || true
  echo "-- Last 5 lines: agent.log  --"; tail -n 5 "$LOGS/agent.log"  2>/dev/null || true
  echo "-- Last 5 lines: demo.log   --"; tail -n 5 "$LOGS/demo.log"   2>/dev/null || true

  if curl_ok "http://localhost:$PORT/json"; then
    if curl -s "http://localhost:$PORT/json" | grep -q 'chrome-extension://'; then
      echo "Extension pages: DETECTED"
    else
      echo "Extension pages: NOT DETECTED (first run: chrome://extensions → Load unpacked → $EXT_DIR)"
    fi
  fi
}

ready() {
  ( cd "$ROOT/extension" && npm install && npm run build )
  start_chrome
  start_agent
  start_demo
  curl -fsS "http://localhost:$PORT/json/new?http://localhost:8788/ehr.html" >/dev/null || true
  status
  echo
  echo "If extension isn't visible: chrome://extensions → Developer mode ON → Load unpacked → $EXT_DIR"
}

stop() {
  echo "Stopping services…"
  pkill -f "remote-debugging-port=$PORT" || true
  pkill -f "python3 -m http.server 8788" || true
  pkill -f "tsx watch src/server.ts" || pkill -f "node .*agent" || true
  sleep 0.5
  echo "Stopped."
}

reset() {
  stop
  rm -rf "$PROFILE"
  rm -f "$LOGS/"*.log || true
  echo "Profile and logs cleared."
  ready
}

case "${1:-}" in
  ready)  ready ;;
  status) status ;;
  stop)   stop ;;
  reset)  reset ;;
  *) echo "Usage: ./word {ready|status|stop|reset}"; exit 2 ;;
esac